---
title: "ESL_ModeltoThreshold"
author: "Tim L"
date: "11/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#packages
```{r}
library(tidyverse);library(lmerTest);library(data.table);library(knitr);library(emmeans)
library(patternplot);library(car);library(multcomp);library(dplyr);library(ggpubr);library(stringi)
library(nlsMicrobio);library(minpack.lm);library(AICcmodavg); library(grid); library(Ryacas); library(biogrowth); library(MASS)

set.seed(88)
```


###Read in Models

##Buchanan Log10
```{r}
# buchanan (in log10 scale)
buchanan_log10 <- LOG10N ~
  LOG10N0 + #base population
  (t >= lag) * (t <= (lag + (LOG10Nmax - LOG10N0) / mumax)) * #if in growth phase
  mumax * (t - lag) + #log-linear growth (assume positive)
  (t >= lag) * (t > (lag + (LOG10Nmax - LOG10N0) / mumax)) * # if in stationary phase (first condition unnecessary)
  (LOG10Nmax - LOG10N0) #take value of Nmax
```


##Gompertz log10
```{r}
# gompertzm (in log10 scale)
gompertzm_log10 <- LOG10N ~ LOG10N0 + 
  (LOG10Nmax - LOG10N0) * exp(-exp(mumax * exp(1) * (lag - t)/((LOG10Nmax - LOG10N0)) + 1))
```

##Baranyi log10
```{r}
# baranyi (in log10 scale)
# (mumax*log(10))
baranyi_log10 <- LOG10N ~ LOG10Nmax + 
  log10((-1 + exp((mumax*log(10)) * lag) + exp((mumax*log(10)) * t))/(exp((mumax*log(10)) * t) - 1 + exp((mumax*log(10)) * lag) * 10^(LOG10Nmax - LOG10N0)))
```


###Read in Data
```{r}
##Filter by storage/HTST temp
mfALLpc <- read.csv("MF_ALL_110822.csv", na.strings = c("", "NA"))

mfkeep <- mfALLpc %>% 
  filter(ExtraInfo != "TNTC" & ExtraInfo != "PPC" & ExtraInfo != "ERROR")
```


###0.8-Whole-10-Overall (COMPLETE 2)
```{r}

#0.8-Whole-10c
W0.8_10 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W0.8_10hrs <- W0.8_10[c("LOG10N", "t")]

#reorder by column index
W0.8_10hrs <- W0.8_10hrs[c(2,1)]

W0.8_10hrs <- W0.8_10hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
#Preview the curve for setting up starting values of the parameters.
#preview(buchanan_log10, W0.8_10hrs, list(LOG10N0 = 1.59,lag = 42, mumax = 0.02, LOG10Nmax = 7.15))
#Fit the data with the model.
#fitW0.8_10.buc_LM <- nlsLM(buchanan_log10, W0.8_10hrs, trace=T, 
                           #list (LOG10N0 = 1.59,lag = 42, mumax = 0.02, LOG10Nmax = 7.15), 
                           #control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           #lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit to buchanan for 0.8-10C-whole milk

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W0.8_10hrs, list(LOG10N0 = 1.59,lag = 84, mumax = 0.02, LOG10Nmax = 7.15))
fitW0.8_10.gom_LM <- nlsLM(gompertzm_log10, W0.8_10hrs, trace=T, 
                           list (LOG10N0 = 1.59,lag = 84, mumax = 0.02, LOG10Nmax = 7.15), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W0.8_10hrs, list(LOG10N0 = 1.59,lag = 84, mumax = 0.02, LOG10Nmax = 7.15))
fitW0.8_10.bar_LM <- nlsLM(baranyi_log10, W0.8_10hrs, trace=T, 
                           list (LOG10N0 = 1.59,lag = 84, mumax = 0.02, LOG10Nmax = 7.15), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW0.8_10.buc_LM
candidate_models[[1]] <- fitW0.8_10.gom_LM
candidate_models[[2]] <- fitW0.8_10.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)
#both gompertz and baranyi are closest model, average days after calculations

coef(fitW0.8_10.gom_LM)
coef(fitW0.8_10.bar_LM)
```


```{r}
library(biogrowth)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 1.59, C = 4.74, mu = 0.17, lambda = 147)

my_time <- seq(0, 840, length = 100)

set.seed(88)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 1.59, logNmax = 6.33, mu = 0.046, lambda = 94)

my_time <- seq(0, 840, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()



time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```
```{r}
my_model <- "modGompertz"
pars <- tribble(
  ~par, ~mean, ~sd, ~scale,
  "logN0", 0, .2, "original",
  "mu", 2, .3, "sqrt",
  "lambda", .5, .1, "log",
  "C", 6, .5, "original"
)
```


###0.8-Whole-10 Trial 2 (no model fit)
```{r}

#0.8-Whole-10c
W0.8_10_T2 <- mfALLpc %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(Trial == 2) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W0.8_10_T2_hrs <- W0.8_10_T2[c("LOG10N", "t")]

#reorder by column index
W0.8_10_T2_hrs <- W0.8_10_T2_hrs[c(2,1)]

W0.8_10_T2_hrs <- W0.8_10_T2_hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
#Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W0.8_10_T2_hrs, list(LOG10N0 = 2.68,lag = 84, mumax = 0.023, LOG10Nmax = 6.62))
# Fit the data with the model.
fitW0.8_10_T2.buc_LM <- nlsLM(buchanan_log10, W0.8_10_T2_hrs, trace=T, 
                    list (LOG10N0 = 2.68,lag = 84, mumax = 0.023, LOG10Nmax = 6.62), 
                     control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                     lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit to buchanan

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W0.8_10_T2_hrs, list(LOG10N0 = 2.68,lag = 84, mumax = 0.023, LOG10Nmax = 6.62))
fitW0.8_10_T2.gom_LM <- nlsLM(gompertzm_log10, W0.8_10_T2_hrs, trace=T, 
                           list (LOG10N0 = 2.68,lag =168, mumax = 0.023, LOG10Nmax = 6.00), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W0.8_10_T2_hrs, list(LOG10N0 = 2.68,lag = 42, mumax = 0.023, LOG10Nmax = 6.62))
fitW0.8_10.bar_LM <- nlsLM(baranyi_log10, W0.8_10_T2_hrs, trace=T, 
                           list (LOG10N0 = 2.68,lag = 84, mumax = 0.023, LOG10Nmax = 6.62), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW0.8_10.buc_LM
candidate_models[[1]] <- fitW0.8_10T2.gom_LM
candidate_models[[2]] <- fitW0.8_10T2.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)
#both gompertz and baranyi are closest model, average days after calculations

coef(fitW0.8_10.gom_LM)
coef(fitW0.8_10.bar_LM)
```


```{r}
library(biogrowth)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 2.68, C = 3.94, mu = 0.023, lambda = 84)

my_time <- seq(0, 840, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 1.59, C = 4.74, mu = 0.044, lambda = 92)

my_time <- seq(0, 2000, length = 1000)

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```








###0.8-Whole-10 Trial 3 (COMPLETE)
```{r}

#0.8-Whole-10c
W0.8_10_T3 <- mfALLpc %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(Trial == 3) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W0.8_10_T3hrs <- W0.8_10_T3[c("LOG10N", "t")]

#reorder by column index
W0.8_10_T3hrs <- W0.8_10_T3hrs[c(2,1)]

W0.8_10_T3hrs <- W0.8_10_T3hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
#Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W0.8_10_T3hrs, list(LOG10N0 = 0.40,lag = 168, mumax = 0.022, LOG10Nmax = 8.20))
# Fit the data with the model.
fitW0.8_10_T3.buc_LM <- nlsLM(buchanan_log10, W0.8_10_T3hrs, trace=T, 
                    list (LOG10N0 = 0.40,lag = 168, mumax = 0.022, LOG10Nmax = 8.20), 
                     control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                     lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W0.8_10_T3hrs, list(LOG10N0 = 0.40,lag = 168, mumax = 0.022, LOG10Nmax = 8.20))
fitW0.8_10_T3.gom_LM <- nlsLM(gompertzm_log10, W0.8_10_T3hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 168, mumax = 0.022, LOG10Nmax = 8.20), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W0.8_10_T3hrs, list(LOG10N0 = 0.40,lag = 168, mumax = 0.022, LOG10Nmax = 8.20))
fitW0.8_10_T3.bar_LM <- nlsLM(baranyi_log10, W0.8_10_T3hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 168, mumax = 0.022, LOG10Nmax = 8.20), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
candidate_models[[1]] <- fitW0.8_10_T3.buc_LM
candidate_models[[2]] <- fitW0.8_10_T3.gom_LM
candidate_models[[3]] <- fitW0.8_10_T3.bar_LM
mod.names <- c("Buchanan","Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)
#both gompertz and baranyi are closest model, average days after calculations

coef(fitW0.8_10_T3.bar_LM)
```


```{r}

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 1.03, logNmax = 6.60, mu = 0.0067, lambda = 0)

my_time <- seq(0, 2000, length = 1000)

set.seed(88)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```





###0.8-Whole-10 Trial 4 (COMPLETE)
```{r}

#0.8-Whole-10c
W0.8_10_T4 <- mfALLpc %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(Trial == 4) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W0.8_10_T4hrs <- W0.8_10_T4[c("LOG10N", "t")]

#reorder by column index
W0.8_10_T4hrs <- W0.8_10_T4hrs[c(2,1)]

W0.8_10_T4hrs <- W0.8_10_T4hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
#Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W0.8_10_T4hrs, list(LOG10N0 = 1.69,lag = 84, mumax = 0.027, LOG10Nmax = 7.81))
# Fit the data with the model.
fitW0.8_10_T4.buc_LM <- nlsLM(buchanan_log10, W0.8_10_T4hrs, trace=T, 
                    list (LOG10N0 = 1.69,lag = 84, mumax = 0.027, LOG10Nmax = 7.81), 
                     control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                     lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

#did not fit 

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W0.8_10_T4hrs, list(LOG10N0 = 1.69,lag = 84, mumax = 0.027, LOG10Nmax = 7.81))
fitW0.8_10_T4.gom_LM <- nlsLM(gompertzm_log10, W0.8_10_T4hrs, trace=T, 
                           list (LOG10N0 = 1.69,lag = 84, mumax = 0.027, LOG10Nmax = 7.81), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W0.8_10_T4hrs, list(LOG10N0 = 1.69,lag = 84, mumax = 0.027, LOG10Nmax = 7.81))
fitW0.8_10_T4.bar_LM <- nlsLM(baranyi_log10, W0.8_10_T4hrs, trace=T, 
                           list (LOG10N0 = 1.69,lag = 84, mumax = 0.027, LOG10Nmax = 7.81), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

#did not fit

# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW0.8_10_T4.buc_LM
candidate_models[[1]] <- fitW0.8_10_T4.gom_LM
#candidate_models[[3]] <- fitW0.8_10_T4.bar_LM
mod.names <- c("Gompertzm")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW0.8_10_T4.gom_LM)
```


```{r}

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 1.69, C = 5.32, mu = 0.20, lambda = 139)

my_time <- seq(0, 2000, length = 1000)

set.seed(88)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```




###1.2-Whole-10-Overall (COMPLETE 2)
```{r}
#1.2-Whole-10c
W1.2_10 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W1.2_10hrs <- W1.2_10[c("LOG10N", "t")]

#reorder by column index
W1.2_10hrs <- W1.2_10hrs[c(2,1)]

W1.2_10hrs <- W1.2_10hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Five candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W1.2_10hrs, list(LOG10N0 = 0.96,lag = 84, mumax = 0.016, LOG10Nmax = 7.62))
# Fit the data with the model.
fitW1.2_10.buc_LM <- nlsLM(buchanan_log10, W1.2_10hrs, trace=T, 
                           list (LOG10N0 = 0.96,lag = 84, mumax = 0.016, LOG10Nmax = 7.62), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W1.2_10hrs, list(LOG10N0 = 0.96,lag = 84, mumax = 0.016, LOG10Nmax = 7.62))
fitW1.2_10.gom_LM <- nlsLM(gompertzm_log10, W1.2_10hrs, trace=T, 
                           list (LOG10N0 = 0.96,lag = 84, mumax = 0.016, LOG10Nmax = 7.62), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W1.2_10hrs, list(LOG10N0 = 0.96,lag = 84, mumax = 0.016, LOG10Nmax = 7.62))
fitW1.2_10.bar_LM <- nlsLM(baranyi_log10, W1.2_10hrs, trace=T, 
                           list (LOG10N0 = 0.96,lag = 42, mumax = 0.016, LOG10Nmax = 7.62), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Compare across models to select the best-fit model.
candidate_models <- list()
candidate_models[[1]] <- fitW1.2_10.buc_LM
candidate_models[[2]] <- fitW1.2_10.gom_LM
candidate_models[[3]] <- fitW1.2_10.bar_LM
mod.names <- c("Buchannan", "Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW1.2_10.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 0.87, C = 6.36, mu = 0.014, lambda = 0)

my_time <- seq(0, 840, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```







###1.2-Whole-10-Trial 1
```{r}
#1.2-Whole-10c
W1.2_10T1 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 1) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W1.2_10T1hrs <- W1.2_10T1[c("LOG10N", "t")]

#reorder by column index
W1.2_10T1hrs <- W1.2_10T1hrs[c(2,1)]

W1.2_10T1hrs <- W1.2_10T1hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Five candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W1.2_10T1hrs, list(LOG10N0 = 0.85,lag = 84, mumax = 0.030, LOG10Nmax = 8.05))
# Fit the data with the model.
fitW1.2_10T1.buc_LM <- nlsLM(buchanan_log10, W1.2_10T1hrs, trace=T, 
                           list (LOG10N0 = 0.85,lag = 84, mumax = 0.030, LOG10Nmax = 8.05), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W1.2_10T1hrs, list(LOG10N0 = 0.85,lag = 84, mumax = 0.030, LOG10Nmax = 8.05))
fitW1.2_10T1.gom_LM <- nlsLM(gompertzm_log10, W1.2_10T1hrs, trace=T, 
                           list (LOG10N0 = 0.85,lag = 84, mumax = 0.030, LOG10Nmax = 8.05), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 3: baranyi_log10
preview(baranyi_log10, W1.2_10T1hrs, list(LOG10N0 = 0.85,lag = 84, mumax = 0.030, LOG10Nmax = 8.05))
fitW1.2_10T1.bar_LM <- nlsLM(baranyi_log10, W1.2_10T1hrs, trace=T, 
                           list (LOG10N0 = 0.85,lag = 84, mumax = 0.030, LOG10Nmax = 8.05), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit
```




###1.2-Whole-10-Trial 2
```{r}
#1.2-Whole-10c
W1.2_10T2 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 1.2) %>%
  filter(Trial == 2) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W1.2_10T2hrs <- W1.2_10T2[c("LOG10N", "t")]

#reorder by column index
W1.2_10T2hrs <- W1.2_10T2hrs[c(2,1)]

W1.2_10T2hrs <- W1.2_10T2hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Five candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W1.2_10T2hrs, list(LOG10N0 = 2.18,lag = 168, mumax = 0.037, LOG10Nmax = 8.69))
# Fit the data with the model.
#fitW1.2_10T2.buc_LM <- nlsLM(buchanan_log10, W1.2_10T2hrs, trace=T, 
    #                       list (LOG10N0 = 2.18,lag = 168, mumax = 0.037, LOG10Nmax = 8.69), 
 #                          control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
 #                          lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W1.2_10T2hrs, list(LOG10N0 = 2.18,lag = 168, mumax = 0.037, LOG10Nmax = 8.69))
fitW1.2_10T2.gom_LM <- nlsLM(gompertzm_log10, W1.2_10T2hrs, trace=T, 
                           list (LOG10N0 = 2.18,lag = 168, mumax = 0.037, LOG10Nmax = 8.69), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W1.2_10T2hrs, list(LOG10N0 = 2.18,lag = 168, mumax = 0.037, LOG10Nmax = 8.69))
fitW1.2_10T2.bar_LM <- nlsLM(baranyi_log10, W1.2_10T2hrs, trace=T, 
                           list (LOG10N0 = 2.18,lag = 168, mumax = 0.037, LOG10Nmax = 8.69), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW1.2_10T2.buc_LM
candidate_models[[1]] <- fitW1.2_10T2.gom_LM
candidate_models[[2]] <- fitW1.2_10T2.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW1.2_10T2.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 1.29, C = 6.34, mu = 0.052, lambda = 215)

my_time <- seq(0, 840, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```


###1.2-Whole-10-Trial 3
```{r}
#1.2-Whole-10c
W1.2_10T3 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 1.2) %>%
  filter(Trial == 3) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W1.2_10T3hrs <- W1.2_10T3[c("LOG10N", "t")]

#reorder by column index
W1.2_10T3hrs <- W1.2_10T3hrs[c(2,1)]

W1.2_10T3hrs <- W1.2_10T3hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Five candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W1.2_10T3hrs, list(LOG10N0 = 0.40,lag = 168, mumax = 0.030, LOG10Nmax = 8.97))
# Fit the data with the model.
#fitW1.2_10T3.buc_LM <- nlsLM(buchanan_log10, W1.2_10T3hrs, trace=T, 
 #                          list (LOG10N0 = 0.40,lag = 168, mumax = 0.030, LOG10Nmax = 8.97), 
  #                   control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
  #                   lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W1.2_10T3hrs, list(LOG10N0 = 0.40,lag = 168, mumax = 0.030, LOG10Nmax = 8.97))
fitW1.2_10T3.gom_LM <- nlsLM(gompertzm_log10, W1.2_10T3hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 168, mumax = 0.030, LOG10Nmax = 8.97), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W1.2_10T3hrs, list(LOG10N0 = 0.40,lag = 168, mumax = 0.030, LOG10Nmax = 8.97))
fitW1.2_10T3.bar_LM <- nlsLM(baranyi_log10, W1.2_10T3hrs, trace=T, 
                           list (LOG10N0 = 2.18,lag = 168, mumax = 0.037, LOG10Nmax = 8.69), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW1.2_10T2.buc_LM
candidate_models[[1]] <- fitW1.2_10T3.gom_LM
candidate_models[[2]] <- fitW1.2_10T3.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW1.2_10T3.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```

```{r}
library(biogrowth)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 0.30, C = 6.89, mu = 0.031, lambda = 153)

my_time <- seq(0, 840, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```


###1.2-Whole-10-Trial 4
```{r}
#1.2-Whole-10c
W1.2_10T4 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 1.2) %>%
  filter(Trial == 4) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W1.2_10T4hrs <- W1.2_10T4[c("LOG10N", "t")]

#reorder by column index
W1.2_10T4hrs <- W1.2_10T4hrs[c(2,1)]

W1.2_10T4hrs <- W1.2_10T4hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Five candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W1.2_10T4hrs, list(LOG10N0 = 0.40,lag = 84, mumax = 0.037, LOG10Nmax = 8.12))
#Fit the data with the model.
fitW1.2_10T4.buc_LM <- nlsLM(buchanan_log10, W1.2_10T4hrs, trace=T, 
                          list (LOG10N0 = 0.40,lag = 84, mumax = 0.037, LOG10Nmax = 8.12), 
                  control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                  lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W1.2_10T4hrs, list(LOG10N0 = 0.40,lag = 84, mumax = 0.037, LOG10Nmax = 8.12))
fitW1.2_10T4.gom_LM <- nlsLM(gompertzm_log10, W1.2_10T4hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 84, mumax = 0.037, LOG10Nmax = 8.12), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 3: baranyi_log10
preview(baranyi_log10, W1.2_10T4hrs, list(LOG10N0 = 0.40,lag = 84, mumax = 0.037, LOG10Nmax = 8.12))
fitW1.2_10T4.bar_LM <- nlsLM(baranyi_log10, W1.2_10T4hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 84, mumax = 0.037, LOG10Nmax = 8.12), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

```


###0.8-Whole-6.5-Overall (COMPLETE 2)
```{r}

#0.8-Skim-6.5c
W0.8_6.5 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W0.8_6.5hrs <- W0.8_6.5[c("LOG10N", "t")]

#reorder by column index
W0.8_6.5hrs <- W0.8_6.5hrs[c(2,1)]

W0.8_6.5hrs <- W0.8_6.5hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W0.8_6.5hrs, list(LOG10N0 = 1.59,lag = 924, mumax = 0.017, LOG10Nmax = 6.02))
# Fit the data with the model.
#fitW0.8_6.5.buc_LM <- nlsLM(buchanan_log10, W0.8_6.5hrs, trace=T, 
                           #list (LOG10N0 = 1.59,lag = 840, mumax = 0.017, LOG10Nmax = 6.02), 
                           #control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           #lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
# Buchanan does not fit


# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W0.8_6.5hrs, list(LOG10N0 = 1.59,lag = 924, mumax = 0.017, LOG10Nmax = 6.02))
fitW0.8_6.5.gom_LM <- nlsLM(gompertzm_log10, W0.8_6.5hrs, trace=T, 
                           list (LOG10N0 = 1.59,lag = 924, mumax = 0.017, LOG10Nmax = 6.02), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W0.8_6.5hrs, list(LOG10N0 = 1.59,lag = 924, mumax = 0.017, LOG10Nmax = 6.02))
fitW0.8_6.5.bar_LM <- nlsLM(baranyi_log10, W0.8_6.5hrs, trace=T, 
                           list (LOG10N0 = 1.59,lag = 924, mumax = 0.017, LOG10Nmax = 6.02), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW0.8_10.buc_LM
candidate_models[[1]] <- fitW0.8_6.5.gom_LM
#candidate_models[[2]] <- fitW0.8_6.5.bar_LM
mod.names <- c("Gompertzm")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW0.8_6.5.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 1.90, C = 3.88, mu = 0.14, lambda = 989)

my_time <- seq(0, 1500, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

#time_to_logcount(static_prediction, 6.0)

set.seed(88)
my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 1.89, logNmax = 5.78, mu = 0.055, lambda = 960)

my_time <- seq(0, 1500, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

#time_to_logcount(static_prediction, 6.0)

```







###0.8-Whole-6.5-Trial 2
```{r}

#0.8-Skim-6.5c
W0.8_6.5T2 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(Trial == 2) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W0.8_6.5T2hrs <- W0.8_6.5T2[c("LOG10N", "t")]

#reorder by column index
W0.8_6.5T2hrs <- W0.8_6.5T2hrs[c(2,1)]

W0.8_6.5T2hrs <- W0.8_6.5T2hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W0.8_6.5T2hrs, list(LOG10N0 = 2.68,lag = 840, mumax = 0.011, LOG10Nmax = 5.15))
# Fit the data with the model.
fitW0.8_6.5T2.buc_LM <- nlsLM(buchanan_log10, W0.8_6.5T2hrs, trace=T, 
                           list (LOG10N0 = 2.68,lag = 840, mumax = 0.011, LOG10Nmax = 5.15), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
# Buchanan does not fit


# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W0.8_6.5T2hrs, list(LOG10N0 = 2.68,lag = 840, mumax = 0.011, LOG10Nmax = 5.15))
fitW0.8_6.5T2.gom_LM <- nlsLM(gompertzm_log10, W0.8_6.5T2hrs, trace=T, 
                           list (LOG10N0 = 2.68,lag = 840, mumax = 0.011, LOG10Nmax = 5.15), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W0.8_6.5T2hrs, list(LOG10N0 = 2.68,lag = 840, mumax = 0.011, LOG10Nmax = 5.15))
fitW0.8_6.5T2.bar_LM <- nlsLM(baranyi_log10, W0.8_6.5T2hrs, trace=T, 
                           list (LOG10N0 = 2.68,lag = 840, mumax = 0.011, LOG10Nmax = 5.15), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW0.8_10.buc_LM
candidate_models[[1]] <- fitW0.8_6.5T2.gom_LM
candidate_models[[2]] <- fitW0.8_6.5T2.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW0.8_6.5T2.bar_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 2.67, logNmax = 5.07, mu = 0.016, lambda = 867)

my_time <- seq(0, 1500, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

#time_to_logcount(static_prediction, 6.0)
```


###0.8-Whole-6.5-Trial 3
```{r}

#0.8-Skim-6.5c
W0.8_6.5T3 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(Trial == 3) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W0.8_6.5T3hrs <- W0.8_6.5T3[c("LOG10N", "t")]

#reorder by column index
W0.8_6.5T3hrs <- W0.8_6.5T3hrs[c(2,1)]

W0.8_6.5T3hrs <- W0.8_6.5T3hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W0.8_6.5T3hrs, list(LOG10N0 = 0.40,lag = 840, mumax = 0.030, LOG10Nmax = 6.08))
# Fit the data with the model.
fitW0.8_6.5T3.buc_LM <- nlsLM(buchanan_log10, W0.8_6.5T3hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 840, mumax = 0.030, LOG10Nmax = 6.08), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
# Buchanan does not fit


# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W0.8_6.5T3hrs, list(LOG10N0 = 0.40,lag = 840, mumax = 0.030, LOG10Nmax = 6.08))
fitW0.8_6.5T3.gom_LM <- nlsLM(gompertzm_log10, W0.8_6.5T3hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 840, mumax = 0.030, LOG10Nmax = 6.08), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 3: baranyi_log10
preview(baranyi_log10, W0.8_6.5T3hrs, list(LOG10N0 = 0.40,lag = 840, mumax = 0.030, LOG10Nmax = 6.08))
fitW0.8_6.5T3.bar_LM <- nlsLM(baranyi_log10, W0.8_6.5T3hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 840, mumax = 0.030, LOG10Nmax = 6.08), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW0.8_10.buc_LM
candidate_models[[1]] <- fitW0.8_6.5T2.gom_LM
candidate_models[[2]] <- fitW0.8_6.5T2.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW0.8_6.5T2.bar_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 2.67, logNmax = 5.07, mu = 0.016, lambda = 867)

my_time <- seq(0, 1500, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

#time_to_logcount(static_prediction, 6.0)
```


###0.8-Whole-6.5-Trial 4
```{r}
#0.8-Skim-6.5c
W0.8_6.5T4 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(Trial == 4) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W0.8_6.5T4hrs <- W0.8_6.5T4[c("LOG10N", "t")]

#reorder by column index
W0.8_6.5T4hrs <- W0.8_6.5T4hrs[c(2,1)]

W0.8_6.5T4hrs <- W0.8_6.5T4hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W0.8_6.5T4hrs, list(LOG10N0 = 1.69,lag = 168, mumax = 0.031, LOG10Nmax = 7.53))
# Fit the data with the model.
fitW0.8_6.5T4.buc_LM <- nlsLM(buchanan_log10, W0.8_6.5T4hrs, trace=T, 
                           list (LOG10N0 = 1.69,lag = 168, mumax = 0.031, LOG10Nmax = 7.53), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
# Buchanan does not fit


# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W0.8_6.5T4hrs, list(LOG10N0 = 1.69,lag = 168, mumax = 0.031, LOG10Nmax = 7.53))
fitW0.8_6.5T4.gom_LM <- nlsLM(gompertzm_log10, W0.8_6.5T4hrs, trace=T, 
                           list (LOG10N0 = 1.69,lag = 168, mumax = 0.031, LOG10Nmax = 7.53), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 3: baranyi_log10
preview(baranyi_log10, W0.8_6.5T4hrs, list(LOG10N0 = 1.69,lag = 168, mumax = 0.031, LOG10Nmax = 7.53))
fitW0.8_6.5T4.bar_LM <- nlsLM(baranyi_log10, W0.8_6.5T4hrs, trace=T, 
                           list (LOG10N0 = 1.69,lag = 168, mumax = 0.031, LOG10Nmax = 7.53), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW0.8_10.buc_LM
#candidate_models[[1]] <- fitW0.8_6.5T2.gom_LM
candidate_models[[1]] <- fitW0.8_6.5T4.bar_LM
mod.names <- c("Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW0.8_6.5T4.bar_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 2.09, logNmax = 6.59, mu = 0.064, lambda = 998)

my_time <- seq(0, 1500, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

#time_to_logcount(static_prediction, 6.0)
```


###1.2-Whole-6.5-Overall (COMPLETE 2)
```{r}
#1.2-Whole-6.5c
W1.2_6.5 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W1.2_6.5hrs <- W1.2_6.5[c("LOG10N", "t")]

#reorder by column index
W1.2_6.5hrs <- W1.2_6.5hrs[c(2,1)]

W1.2_6.5hrs <- W1.2_6.5hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)


# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W1.2_6.5hrs, list(LOG10N0 = 0.96,lag = 336, mumax = 0.011, LOG10Nmax = 4.16))
# Fit the data with the model.
#fitW1.2_6.5.buc_LM <- nlsLM(buchanan_log10, W1.2_6.5hrs, trace=T, 
                          #list (LOG10N0 = 0.96,lag = 336, mumax = 0.01, LOG10Nmax = 4.16), 
                           #control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           #lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#Buchanan did not work

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W1.2_6.5hrs, list(LOG10N0 = 0.96,lag = 336, mumax = 0.011, LOG10Nmax = 4.16))
fitW1.2_6.5.gom_LM <- nlsLM(gompertzm_log10, W1.2_6.5hrs, trace=T, 
                           list (LOG10N0 = 0.96,lag = 336, mumax = 0.011, LOG10Nmax = 4.16), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W1.2_6.5hrs, list(LOG10N0 = 0.96,lag = 336, mumax = 0.011, LOG10Nmax = 4.16))
fitW1.2_6.5.bar_LM <- nlsLM(baranyi_log10, W1.2_6.5hrs, trace=T, 
                           list (LOG10N0 = 0.96,lag = 336, mumax = 0.011, LOG10Nmax = 4.16), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW1.2_10.buc_LM
candidate_models[[1]] <- fitW1.2_6.5.gom_LM
candidate_models[[2]] <- fitW1.2_6.5.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW1.2_6.5.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 0, C = 4.16, mu = 0.0046, lambda = 962)

my_time <- seq(0, 2000, length = 2000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

#used observed Nmax of whole-1.2-6.5C (4.16 log) given the predicted was 37 log
time_to_logcount(static_prediction, 4.301)

predict

#time_to_logcount(static_prediction, 6.0)

```



###1.2-Whole-6.5-Trial 1
```{r}
#1.2-Whole-6.5c
W1.2_6.5T1 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 1) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W1.2_6.5T1hrs <- W1.2_6.5T1[c("LOG10N", "t")]

#reorder by column index
W1.2_6.5T1hrs <- W1.2_6.5T1hrs[c(2,1)]

W1.2_6.5T1hrs <- W1.2_6.5T1hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)


# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W1.2_6.5hrs, list(LOG10N0 = 0.96,lag = 336, mumax = 0.011, LOG10Nmax = 4.16))
# Fit the data with the model.
#fitW1.2_6.5.buc_LM <- nlsLM(buchanan_log10, W1.2_6.5hrs, trace=T, 
                          #list (LOG10N0 = 0.96,lag = 336, mumax = 0.01, LOG10Nmax = 4.16), 
                           #control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           #lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#Buchanan did not work

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W1.2_6.5hrs, list(LOG10N0 = 0.96,lag = 336, mumax = 0.011, LOG10Nmax = 4.16))
fitW1.2_6.5.gom_LM <- nlsLM(gompertzm_log10, W1.2_6.5hrs, trace=T, 
                           list (LOG10N0 = 0.96,lag = 336, mumax = 0.011, LOG10Nmax = 4.16), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W1.2_6.5hrs, list(LOG10N0 = 0.96,lag = 336, mumax = 0.011, LOG10Nmax = 4.16))
fitW1.2_6.5.bar_LM <- nlsLM(baranyi_log10, W1.2_6.5hrs, trace=T, 
                           list (LOG10N0 = 0.96,lag = 336, mumax = 0.011, LOG10Nmax = 4.16), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW1.2_10.buc_LM
candidate_models[[1]] <- fitW1.2_6.5.gom_LM
candidate_models[[2]] <- fitW1.2_6.5.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW1.2_6.5.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 0, C = 4.16, mu = 0.0046, lambda = 962)

my_time <- seq(0, 2000, length = 2000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

#used observed Nmax of whole-1.2-6.5C (4.16 log) given the predicted was 37 log
time_to_logcount(static_prediction, 4.301)

predict

#time_to_logcount(static_prediction, 6.0)

```


###1.2-Whole-6.5-Trial 2
```{r}
#1.2-Whole-6.5c
W1.2_6.5T2 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 2) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W1.2_6.5T2hrs <- W1.2_6.5T2[c("LOG10N", "t")]

#reorder by column index
W1.2_6.5T2hrs <- W1.2_6.5T2hrs[c(2,1)]

W1.2_6.5T2hrs <- W1.2_6.5T2hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)


# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W1.2_6.5T2hrs, list(LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60))
# Fit the data with the model.
fitW1.2_6.5T2.buc_LM <- nlsLM(buchanan_log10, W1.2_6.5T2hrs, trace=T, 
                          list (LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W1.2_6.5T2hrs, list(LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60))
fitW1.2_6.5T2.gom_LM <- nlsLM(gompertzm_log10, W1.2_6.5T2hrs, trace=T, 
                           list (LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W1.2_6.5T2hrs, list(LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60))
fitW1.2_6.5T2.bar_LM <- nlsLM(baranyi_log10, W1.2_6.5T2hrs, trace=T, 
                           list (LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Compare across models to select the best-fit model.
candidate_models <- list()
candidate_models[[1]] <- fitW1.2_6.5T2.buc_LM
candidate_models[[2]] <- fitW1.2_6.5T2.gom_LM
candidate_models[[3]] <- fitW1.2_6.5T2.bar_LM
mod.names <- c("Buchanan", "Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW1.2_6.5T2.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 2.07, C = 5.08, mu = 0.0069, lambda = 718)

my_time <- seq(0, 2000, length = 2000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

```

###1.2-Skim-6.5-Trial3
```{r}
#1.2-Whole-6.5c
W1.2_6.5T3 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 3) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W1.2_6.5T3hrs <- W1.2_6.5T3[c("LOG10N", "t")]

#reorder by column index
W1.2_6.5T3hrs <- W1.2_6.5T3hrs[c(2,1)]

W1.2_6.5T3hrs <- W1.2_6.5T3hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)


# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W1.2_6.5T2hrs, list(LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60))
# Fit the data with the model.
fitW1.2_6.5T2.buc_LM <- nlsLM(buchanan_log10, W1.2_6.5T2hrs, trace=T, 
                          list (LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W1.2_6.5T2hrs, list(LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60))
fitW1.2_6.5T2.gom_LM <- nlsLM(gompertzm_log10, W1.2_6.5T2hrs, trace=T, 
                           list (LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, W1.2_6.5T2hrs, list(LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60))
fitW1.2_6.5T2.bar_LM <- nlsLM(baranyi_log10, W1.2_6.5T2hrs, trace=T, 
                           list (LOG10N0 = 2.18,lag = 840, mumax = 0.0078, LOG10Nmax = 6.60), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Compare across models to select the best-fit model.
candidate_models <- list()
candidate_models[[1]] <- fitW1.2_6.5T2.buc_LM
candidate_models[[2]] <- fitW1.2_6.5T2.gom_LM
candidate_models[[3]] <- fitW1.2_6.5T2.bar_LM
mod.names <- c("Buchanan", "Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW1.2_6.5T2.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 2.07, C = 5.08, mu = 0.0069, lambda = 718)

my_time <- seq(0, 2000, length = 2000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

```
###1.2-Skim-6.5-Trial4
```{r}
#1.2-Whole-6.5c
W1.2_6.5T4 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 4) %>% 
  filter(MilkType == "Whole") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

W1.2_6.5T4hrs <- W1.2_6.5T4[c("LOG10N", "t")]

#reorder by column index
W1.2_6.5T4hrs <- W1.2_6.5T4hrs[c(2,1)]

W1.2_6.5T4hrs <- W1.2_6.5T4hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean))
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)


# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, W1.2_6.5T4hrs, list(LOG10N0 = 0.40,lag = 336, mumax = 0.034, LOG10Nmax = 6.41))
# Fit the data with the model.
fitW1.2_6.5T4.buc_LM <- nlsLM(buchanan_log10, W1.2_6.5T4hrs, trace=T, 
                          list (LOG10N0 = 0.40,lag = 336, mumax = 0.034, LOG10Nmax = 6.41), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, W1.2_6.5T4hrs, list(LOG10N0 = 0.40,lag = 336, mumax = 0.034, LOG10Nmax = 6.41))
fitW1.2_6.5T4.gom_LM <- nlsLM(gompertzm_log10, W1.2_6.5T4hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 336, mumax = 0.034, LOG10Nmax = 6.41), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 3: baranyi_log10
preview(baranyi_log10, W1.2_6.5T4hrs, list(LOG10N0 = 0.40,lag = 336, mumax = 0.034, LOG10Nmax = 6.41))
fitW1.2_6.5T4.bar_LM <- nlsLM(baranyi_log10, W1.2_6.5T4hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 336, mumax = 0.034, LOG10Nmax = 6.41), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Compare across models to select the best-fit model.
candidate_models <- list()
candidate_models[[1]] <- fitW1.2_6.5T2.buc_LM
candidate_models[[2]] <- fitW1.2_6.5T2.gom_LM
candidate_models[[3]] <- fitW1.2_6.5T2.bar_LM
mod.names <- c("Buchanan", "Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitW1.2_6.5T2.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 2.07, C = 5.08, mu = 0.0069, lambda = 718)

my_time <- seq(0, 2000, length = 2000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

```
```{r}
##Filter by storage/HTST temp
mfALLpc <- read.csv("MF_ALL_071922.csv", na.strings = c("", "NA"))

#1.2-Skim-6.5c
S1.2_6.5_T3 <- mfALLpc %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 3) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S1.2_6.5hrs_T3 <- S1.2_6.5_T3[c("LOG10N", "t")]

#reorder by column index
S1.2_6.5hrs_T3 <- S1.2_6.5hrs_T3[c(2,1)]

S1.2_6.5hrs_T3 <- S1.2_6.5hrs_T3 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 3.61))
# Fit the data with the model.
fitS1.2_6.5.buc_LM_T3 <- nlsLM(buchanan_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 3.61), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 3.61))
fitS1.2_6.5.gom_LM_T3 <- nlsLM(gompertzm_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 6.00), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 3.61))
fitS1.2_6.5.bar_LM_T3 <- nlsLM(baranyi_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 4.22), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
candidate_models[[1]] <- fitS1.2_6.5.buc_LM_T2
candidate_models[[2]] <- fitS1.2_6.5.gom_LM_T2
candidate_models[[3]] <- fitS1.2_6.5.bar_LM_T2
#candidate_models[[5]] <- fitl3051_C.bar_nl_LM
mod.names <- c("Buchannan", "modGompertz", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS1.2_6.5.gom_LM_T2)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 1.25, C = 4.08, mu = 0.013, lambda = 779)

my_time <- seq(0, 4000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```



###0.8-Skim-6.5 (COMPLETE 2)
```{r}
#0.8-Skim-10c
S0.8_6.5 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S0.8_6.5hrs <- S0.8_6.5[c("LOG10N", "t")]

#reorder by column index
S0.8_6.5hrs <- S0.8_6.5hrs[c(2,1)]

S0.8_6.5hrs <- S0.8_6.5hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S0.8_6.5hrs, list(LOG10N0 = 1.67,lag = 756, mumax = 0.012, LOG10Nmax = 5.58))
# Fit the data with the model.
#fitS0.8_6.5.buc_LM <- nlsLM(buchanan_log10, S0.8_6.5hrs, trace=T, 
                          # list (LOG10N0 = 1.67,lag = 672, mumax = 0.012, LOG10Nmax = 5.58), 
                           #control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           #lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit to buchanan for 0.8-6.5C-Skim

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S0.8_6.5hrs, list(LOG10N0 = 1.67,lag = 756, mumax = 0.012, LOG10Nmax = 5.58))
fitS0.8_6.5.gom_LM <- nlsLM(gompertzm_log10, S0.8_6.5hrs, trace=T, 
                           list (LOG10N0 = 1.67,lag = 756, mumax = 0.012, LOG10Nmax = 5.58), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, S0.8_6.5hrs, list(LOG10N0 = 1.67,lag = 756, mumax = 0.012, LOG10Nmax = 5.58))
fitS0.8_6.5.bar_LM <- nlsLM(baranyi_log10, S0.8_6.5hrs, trace=T, 
                           list (LOG10N0 = 1.67,lag = 756, mumax = 0.012, LOG10Nmax = 5.58), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW0.8_10.buc_LM
#candidate_models[[2]] <- fitl3051_C.buc_nl_LM
candidate_models[[1]] <- fitS0.8_6.5.gom_LM
candidate_models[[2]] <- fitS0.8_6.5.bar_LM
#candidate_models[[5]] <- fitl3051_C.bar_nl_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)
#baranyi is closest model

coef(fitS0.8_6.5.bar_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 1.76, logNmax = 5.15, mu = 0.018, lambda = 722)

my_time <- seq(0, 2000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

#time_to_logcount(static_prediction, 6.0)

```




###0.8-Skim-6.5-Trial 2
```{r}
#0.8-Skim-10c
S0.8_6.5T2 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(Trial == 2) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S0.8_6.5T2hrs <- S0.8_6.5T2[c("LOG10N", "t")]

#reorder by column index
S0.8_6.5T2hrs <- S0.8_6.5T2hrs[c(2,1)]

S0.8_6.5T2hrs <- S0.8_6.5T2hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S0.8_6.5T2hrs, list(LOG10N0 = 2.85,lag = 672, mumax = 0.012, LOG10Nmax = 6.96))
# Fit the data with the model.
fitS0.8_6.5T2.buc_LM <- nlsLM(buchanan_log10, S0.8_6.5T2hrs, trace=T, 
                          list (LOG10N0 = 2.85,lag = 672, mumax = 0.012, LOG10Nmax = 6.96), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit 

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S0.8_6.5T2hrs, list(LOG10N0 = 2.85,lag = 672, mumax = 0.012, LOG10Nmax = 6.96))
fitS0.8_6.5T2.gom_LM <- nlsLM(gompertzm_log10, S0.8_6.5T2hrs, trace=T, 
                           list (LOG10N0 = 2.85,lag = 672, mumax = 0.012, LOG10Nmax = 6.96), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, S0.8_6.5T2hrs, list(LOG10N0 = 2.85,lag = 672, mumax = 0.012, LOG10Nmax = 6.96))
fitS0.8_6.5T2.bar_LM <- nlsLM(baranyi_log10, S0.8_6.5T2hrs, trace=T, 
                           list (LOG10N0 = 2.85,lag = 672, mumax = 0.012, LOG10Nmax = 6.96), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW0.8_10.buc_LM
#candidate_models[[2]] <- fitl3051_C.buc_nl_LM
candidate_models[[1]] <- fitS0.8_6.5T2.gom_LM
#candidate_models[[2]] <- fitS0.8_6.5.bar_LM
#candidate_models[[5]] <- fitl3051_C.bar_nl_LM
mod.names <- c("Gompertzm")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)
#baranyi is closest model

coef(fitS0.8_6.5T2.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 2.62, C = 3.18, mu = 0.070, lambda = 669)

my_time <- seq(0, 2000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

```






###0.8-Skim-6.5-Trial 3
```{r}
#0.8-Skim-10c
S0.8_6.5T3 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(Trial == 3) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S0.8_6.5T3hrs <- S0.8_6.5T3[c("LOG10N", "t")]

#reorder by column index
S0.8_6.5T3hrs <- S0.8_6.5T3hrs[c(2,1)]

S0.8_6.5T3hrs <- S0.8_6.5T3hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S0.8_6.5T3hrs, list(LOG10N0 = 0.40,lag = 840, mumax = 0.015, LOG10Nmax = 5.21))
# Fit the data with the model.
fitS0.8_6.5T3.buc_LM <- nlsLM(buchanan_log10, S0.8_6.5T3hrs, trace=T, 
                          list (LOG10N0 = 0.40,lag = 840, mumax = 0.015, LOG10Nmax = 5.21), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit 

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S0.8_6.5T3hrs, list(LOG10N0 = 0.40,lag = 840, mumax = 0.015, LOG10Nmax = 5.21))
fitS0.8_6.5T3.gom_LM <- nlsLM(gompertzm_log10, S0.8_6.5T3hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 840, mumax = 0.015, LOG10Nmax = 5.21), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, S0.8_6.5T3hrs, list(LOG10N0 = 0.40,lag = 840, mumax = 0.015, LOG10Nmax = 5.21))
fitS0.8_6.5T3.bar_LM <- nlsLM(baranyi_log10, S0.8_6.5T3hrs, trace=T, 
                           list (LOG10N0 = 0.40,lag = 840, mumax = 0.015, LOG10Nmax = 5.21), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW0.8_10.buc_LM
candidate_models[[1]] <- fitS0.8_6.5T3.gom_LM
candidate_models[[2]] <- fitS0.8_6.5T3.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)
#baranyi is closest model

coef(fitS0.8_6.5T3.bar_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 0.79, logNmax = 4.44, mu = 0.018, lambda = 852)

my_time <- seq(0, 2000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

```


###0.8-Skim-6.5-Trial 4
```{r}
#0.8-Skim-10c
S0.8_6.5T4 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(Trial == 4) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S0.8_6.5T4hrs <- S0.8_6.5T4[c("LOG10N", "t")]

#reorder by column index
S0.8_6.5T4hrs <- S0.8_6.5T4hrs[c(2,1)]

S0.8_6.5T4hrs <- S0.8_6.5T4hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S0.8_6.5T4hrs, list(LOG10N0 = 1.75,lag = 672, mumax = 0.027, LOG10Nmax = 7.03))
# Fit the data with the model.
fitS0.8_6.5T4.buc_LM <- nlsLM(buchanan_log10, S0.8_6.5T4hrs, trace=T, 
                          list (LOG10N0 = 1.75,lag = 672, mumax = 0.027, LOG10Nmax = 7.03), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit 

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S0.8_6.5T4hrs, list(LOG10N0 = 1.75,lag = 672, mumax = 0.027, LOG10Nmax = 7.03))
fitS0.8_6.5T4.gom_LM <- nlsLM(gompertzm_log10, S0.8_6.5T4hrs, trace=T, 
                           list (LOG10N0 = 1.75,lag = 672, mumax = 0.027, LOG10Nmax = 7.03), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit


# Fit model 3: baranyi_log10
preview(baranyi_log10, S0.8_6.5T4hrs, list(LOG10N0 = 1.75,lag = 672, mumax = 0.027, LOG10Nmax = 7.03))
fitS0.8_6.5T4.bar_LM <- nlsLM(baranyi_log10, S0.8_6.5T4hrs, trace=T, 
                           list (LOG10N0 = 1.75,lag = 672, mumax = 0.027, LOG10Nmax = 7.03), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitW0.8_10.buc_LM
candidate_models[[1]] <- fitS0.8_6.5T3.gom_LM
candidate_models[[2]] <- fitS0.8_6.5T3.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)
#baranyi is closest model

coef(fitS0.8_6.5T3.bar_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 0.79, logNmax = 4.44, mu = 0.018, lambda = 852)

my_time <- seq(0, 2000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

```






###1.2-Skim-6.5 (COMPLETE 2)
```{r}

#1.2-Skim-6.5c
S1.2_6.5 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S1.2_6.5hrs <- S1.2_6.5[c("LOG10N", "t")]

#reorder by column index
S1.2_6.5hrs <- S1.2_6.5hrs[c(2,1)]

S1.2_6.5hrs <- S1.2_6.5hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S1.2_6.5hrs, list(LOG10N0 = 0.51,lag = 336, mumax = 0.0054, LOG10Nmax = 2.91))
# Fit the data with the model.
fitS1.2_6.5.buc_LM <- nlsLM(buchanan_log10, S1.2_6.5hrs, trace=T, 
                           list (LOG10N0 = 0.51,lag = 336, mumax = 0.0054, LOG10Nmax = 2.91), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S1.2_6.5hrs, list(LOG10N0 = 0.51,lag = 336, mumax = 0.0054, LOG10Nmax = 2.91))
fitS1.2_6.5.gom_LM <- nlsLM(gompertzm_log10, S1.2_6.5hrs, trace=T, 
                           list (LOG10N0 = 0.51,lag = 336, mumax = 0.0054, LOG10Nmax = 2.91), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S1.2_6.5hrs, list(LOG10N0 = 0.51,lag = 336, mumax = 0.0054, LOG10Nmax = 2.91))
fitS1.2_6.5.bar_LM <- nlsLM(baranyi_log10, S1.2_6.5hrs, trace=T, 
                           list (LOG10N0 = 0.51,lag = 336, mumax = 0.0054, LOG10Nmax = 2.91), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
candidate_models[[1]] <- fitS1.2_6.5.buc_LM
candidate_models[[2]] <- fitS1.2_6.5.gom_LM
candidate_models[[3]] <- fitS1.2_6.5.bar_LM
#candidate_models[[5]] <- fitl3051_C.bar_nl_LM
mod.names <- c("Buchanan", "Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)

coef(fitS1.2_6.5.bar_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 0.51, logNmax = 1.96, mu = 0.0036, lambda = 354)

my_time <- seq(0, 10000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)


```


###1.2-Skim-6.5-Trial1
```{r}
##Filter by storage/HTST temp

#1.2-Skim-6.5c
S1.2_6.5_T1 <- mfkeep %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 1) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S1.2_6.5hrs_T1 <- S1.2_6.5_T1[c("LOG10N", "t")]

#reorder by column index
S1.2_6.5hrs_T1 <- S1.2_6.5hrs_T1[c(2,1)]

S1.2_6.5hrs_T1 <- S1.2_6.5hrs_T1 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S1.2_6.5hrs_T1, list(LOG10N0 = 0.40,lag = 1344, mumax = 0.003, LOG10Nmax = 0.85))
# Fit the data with the model.
fitS1.2_6.5.buc_LM_T1 <- nlsLM(buchanan_log10, S1.2_6.5hrs_T1, list(LOG10N0 = 0.40,lag = 1344, mumax = 0.003, LOG10Nmax = 0.85), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S1.2_6.5hrs_T1, list(LOG10N0 = 0.40,lag = 1344, mumax = 0.012, LOG10Nmax = 4.22))
fitS1.2_6.5.gom_LM_T1 <- nlsLM(gompertzm_log10, S1.2_6.5hrs_T1, list(LOG10N0 = 0.40,lag = 1344, mumax = 0.012, LOG10Nmax = 4.22), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S1.2_6.5hrs_T1, list(LOG10N0 = 0.40,lag = 1344, mumax = 0.012, LOG10Nmax = 4.22))
fitS1.2_6.5.bar_LM_T1 <- nlsLM(baranyi_log10, S1.2_6.5hrs_T1, list(LOG10N0 = 0.40,lag = 1344, mumax = 0.012, LOG10Nmax = 4.22), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitS1.2_6.5.buc_LM
#candidate_models[[1]] <- fitS1.2_6.5.gom_LM
candidate_models[[1]] <- fitS1.2_6.5.bar_LM_T1
#candidate_models[[5]] <- fitl3051_C.bar_nl_LM
mod.names <- c("Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS1.2_6.5.bar_LM_T1)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 0.50, logNmax = 0.042, mu = 6.83e-10, lambda = 420)

my_time <- seq(0, 10000, length = 10000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```

###1.2-Skim-6.5-Trial2
```{r}
#1.2-Skim-6.5c
S1.2_6.5_T2 <- mfALLpc %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 2) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S1.2_6.5hrs_T2 <- S1.2_6.5_T2[c("LOG10N", "t")]

#reorder by column index
S1.2_6.5hrs_T2 <- S1.2_6.5hrs_T2[c(2,1)]

S1.2_6.5hrs_T2 <- S1.2_6.5hrs_T2 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S1.2_6.5hrs_T2, list(LOG10N0 = 0.86,lag = 840, mumax = 0.014, LOG10Nmax = 6.00))
# Fit the data with the model.
fitS1.2_6.5.buc_LM_T2 <- nlsLM(buchanan_log10, S1.2_6.5hrs_T2, list(LOG10N0 = 0.86,lag = 840, mumax = 0.014, LOG10Nmax = 6.00), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S1.2_6.5hrs_T2, list(LOG10N0 = 0.86,lag = 840, mumax = 0.014, LOG10Nmax = 6.00))
fitS1.2_6.5.gom_LM_T2 <- nlsLM(gompertzm_log10, S1.2_6.5hrs_T2, list(LOG10N0 = 0.86,lag = 840, mumax = 0.014, LOG10Nmax = 6.00), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S1.2_6.5hrs_T2, list(LOG10N0 = 0.86,lag = 840, mumax = 0.014, LOG10Nmax = 6.00))
fitS1.2_6.5.bar_LM_T2 <- nlsLM(baranyi_log10, S1.2_6.5hrs_T2, list(LOG10N0 = 0.86,lag = 840, mumax = 0.014, LOG10Nmax = 6.00), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
candidate_models[[1]] <- fitS1.2_6.5.buc_LM_T2
candidate_models[[2]] <- fitS1.2_6.5.gom_LM_T2
candidate_models[[3]] <- fitS1.2_6.5.bar_LM_T2
#candidate_models[[5]] <- fitl3051_C.bar_nl_LM
mod.names <- c("Buchannan", "modGompertz", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS1.2_6.5.gom_LM_T2)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 1.25, C = 4.08, mu = 0.013, lambda = 779)

my_time <- seq(0, 4000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

```


###1.2-Skim-6.5-Trial3
```{r}
#1.2-Skim-6.5c
S1.2_6.5_T3 <- mfALLpc %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 3) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S1.2_6.5hrs_T3 <- S1.2_6.5_T3[c("LOG10N", "t")]

#reorder by column index
S1.2_6.5hrs_T3 <- S1.2_6.5hrs_T3[c(2,1)]

S1.2_6.5hrs_T3 <- S1.2_6.5hrs_T3 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 3.61))
# Fit the data with the model.
fitS1.2_6.5.buc_LM_T3 <- nlsLM(buchanan_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 3.61), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 3.61))
fitS1.2_6.5.gom_LM_T3 <- nlsLM(gompertzm_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 3.61), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit


# Fit model 3: baranyi_log10
preview(baranyi_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 3.61))
fitS1.2_6.5.bar_LM_T3 <- nlsLM(baranyi_log10, S1.2_6.5hrs_T3, list(LOG10N0 = 0.40,lag = 1008, mumax = 0.016, LOG10Nmax = 3.61), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit


# Compare across models to select the best-fit model.
candidate_models <- list()
candidate_models[[1]] <- fitS1.2_6.5.buc_LM_T2
candidate_models[[2]] <- fitS1.2_6.5.gom_LM_T2
candidate_models[[3]] <- fitS1.2_6.5.bar_LM_T2
#candidate_models[[5]] <- fitl3051_C.bar_nl_LM
mod.names <- c("Buchannan", "modGompertz", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS1.2_6.5.gom_LM_T2)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 1.25, C = 4.08, mu = 0.013, lambda = 779)

my_time <- seq(0, 4000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

```



###1.2-Skim-6.5-Trial4
```{r}
#1.2-Skim-6.5c
S1.2_6.5_T4 <- mfALLpc %>% 
  filter(StorageTemp == 6.5) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 4) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S1.2_6.5hrs_T4 <- S1.2_6.5_T4[c("LOG10N", "t")]

#reorder by column index
S1.2_6.5hrs_T4 <- S1.2_6.5hrs_T4[c(2,1)]

S1.2_6.5hrs_T4 <- S1.2_6.5hrs_T4 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S1.2_6.5hrs_T4, list(LOG10N0 = 0.40,lag = 336, mumax = 0.030, LOG10Nmax = 8.15))
# Fit the data with the model.
fitS1.2_6.5.buc_LM_T4 <- nlsLM(buchanan_log10, S1.2_6.5hrs_T4, list(LOG10N0 = 0.40,lag = 336, mumax = 0.030, LOG10Nmax = 8.15), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S1.2_6.5hrs_T4, list(LOG10N0 = 0.40,lag = 336, mumax = 0.030, LOG10Nmax = 8.15))
fitS1.2_6.5.gom_LM_T4 <- nlsLM(gompertzm_log10, S1.2_6.5hrs_T4, list(LOG10N0 = 0.40,lag = 336, mumax = 0.030, LOG10Nmax = 8.15), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Fit model 3: baranyi_log10
preview(baranyi_log10, S1.2_6.5hrs_T4, list(LOG10N0 = 0.40,lag = 336, mumax = 0.030, LOG10Nmax = 8.15))
fitS1.2_6.5.bar_LM_T4 <- nlsLM(baranyi_log10, S1.2_6.5hrs_T4, list(LOG10N0 = 0.40,lag = 336, mumax = 0.030, LOG10Nmax = 8.15), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitS1.2_6.5.buc_LM_T4
candidate_models[[1]] <- fitS1.2_6.5.gom_LM_T4
candidate_models[[2]] <- fitS1.2_6.5.bar_LM_T4
#candidate_models[[5]] <- fitl3051_C.bar_nl_LM
mod.names <- c("modGompertz", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS1.2_6.5.gom_LM_T4)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)

my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 0.21, C = 4.86, mu = 0.0080, lambda = 211)

my_time <- seq(0, 4000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

```





###1.2-Skim-10-(COMPLETE 2)
```{r}
##Filter by storage/HTST temp

#1.2-Skim-10c
S1.2_10 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S1.2_10hrs <- S1.2_10[c("LOG10N", "t")]

#reorder by column index
S1.2_10hrs <- S1.2_10hrs[c(2,1)]

S1.2_10hrs <- S1.2_10hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
#preview(buchanan_log10, S1.2_10hrs, list(LOG10N0 = 0.51,lag = 168, mumax = 0.018, LOG10Nmax = 6.37))
# Fit the data with the model.
#fitS1.2_10.buc_LM <- nlsLM(buchanan_log10, S1.2_10hrs, trace=T, 
                         #  list (LOG10N0 = 0.51,lag = 168, mumax = 0.018, LOG10Nmax = 6.37), 
                          # control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                          # lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

#could not fit buchannan

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S1.2_10hrs, list(LOG10N0 = 0.51,lag = 252, mumax = 0.018, LOG10Nmax = 6.37))
fitS1.2_10.gom_LM <- nlsLM(gompertzm_log10, S1.2_10hrs, trace=T, 
                           list (LOG10N0 = 0.51,lag = 252, mumax = 0.018, LOG10Nmax = 6.37), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S1.2_10hrs, list(LOG10N0 = 0.51,lag = 252, mumax = 0.018, LOG10Nmax = 6.37))
fitS1.2_10.bar_LM <- nlsLM(baranyi_log10, S1.2_10hrs, trace=T, 
                           list (LOG10N0 = 0.51,lag = 252, mumax = 0.018, LOG10Nmax = 6.37), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
c#andidate_models[[1]] <- fitS1.2_10.buc_LM
candidate_models[[1]] <- fitS1.2_10.gom_LM
candidate_models[[2]] <- fitS1.2_10.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS1.2_10.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)
my_model <- "modGompertz"

primary_model_data("modGompertz")

#predicted Nmax was below 6 log and was not getting time to 1 million. Switched to obsereved Nmax (6.37 log) to get time to 1 mil.    
my_pars <- list(logN0 = 0.36, C = 6.01, mu = 0.013, lambda = 121)

my_time <- seq(0, 1000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```







###1.2-Skim-10-Trial 1
```{r}
#1.2-Skim-10c
S1.2_10T1 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 1) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S1.2_10hrsT1 <- S1.2_10T1[c("LOG10N", "t")]

#reorder by column index
S1.2_10hrsT1 <- S1.2_10hrsT1[c(2,1)]

S1.2_10hrsT1 <- S1.2_10hrsT1 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S1.2_10hrsT1, list(LOG10N0 = 0.40,lag = 840, mumax = 0.021, LOG10Nmax = 6.35))
# Fit the data with the model.
fitS1.2_10T1.buc_LM <- nlsLM(buchanan_log10, S1.2_10hrsT1, trace=T, 
                         list (LOG10N0 = 0.40,lag = 840, mumax = 0.021, LOG10Nmax = 6.35), 
                          control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                          lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

#could not fit buchannan

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S1.2_10hrsT1, list(LOG10N0 = 0.40,lag = 840, mumax = 0.021, LOG10Nmax = 6.35))
fitS1.2_10T1.gom_LM <- nlsLM(gompertzm_log10, S1.2_10hrsT1, trace=T, 
                           list (LOG10N0 = 0.40,lag = 840, mumax = 0.021, LOG10Nmax = 6.35), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S1.2_10hrsT1, list(LOG10N0 = 0.40,lag = 840, mumax = 0.021, LOG10Nmax = 6.35))
fitS1.2_10T1.bar_LM <- nlsLM(baranyi_log10, S1.2_10hrsT1, trace=T, 
                           list (LOG10N0 = 0.40,lag = 840, mumax = 0.021, LOG10Nmax = 6.35), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitS1.2_10.buc_LM
candidate_models[[1]] <- fitS1.2_10T1.gom_LM
candidate_models[[2]] <- fitS1.2_10T1.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS1.2_10T1.gom_LM)
coef(fitS1.2_10T1.bar_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)
my_model <- "modGompertz"

primary_model_data("modGompertz")

#switched N0 and Nmax because values did not make sense
my_pars <- list(logN0 = 0.63, C = 2.73, mu = 0.95, lambda = 846)

my_time <- seq(0, 1000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

my_model <- "Baranyi"

primary_model_data("Baranyi")

#switched N0 and Nmax because values did not make sense
my_pars <- list(logN0 = 0.63, logNmax = 3.37, mu = 0.048, lambda = 791)

my_time <- seq(0, 1000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)


```

###1.2-Skim-10-Trial 2
```{r}
#1.2-Skim-10c
S1.2_10T2 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 2) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S1.2_10hrsT2 <- S1.2_10T2[c("LOG10N", "t")]

#reorder by column index
S1.2_10hrsT2 <- S1.2_10hrsT2[c(2,1)]

S1.2_10hrsT2 <- S1.2_10hrsT2 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S1.2_10hrsT2, list(LOG10N0 = 0.86,lag = 336, mumax = 0.018, LOG10Nmax = 8.22))
# Fit the data with the model.
fitS1.2_10T2.buc_LM <- nlsLM(buchanan_log10, S1.2_10hrsT2, trace=T, 
                         list (LOG10N0 = 0.86,lag = 336, mumax = 0.018, LOG10Nmax = 8.22), 
                          control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                          lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

#could not fit buchannan

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S1.2_10hrsT2, list(LOG10N0 = 0.86,lag = 336, mumax = 0.018, LOG10Nmax = 8.22))
fitS1.2_10T2.gom_LM <- nlsLM(gompertzm_log10, S1.2_10hrsT2, trace=T, 
                           list (LOG10N0 = 0.86,lag = 336, mumax = 0.018, LOG10Nmax = 8.22), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S1.2_10hrsT2, list(LOG10N0 = 0.86,lag = 336, mumax = 0.018, LOG10Nmax = 8.22))
fitS1.2_10T2.bar_LM <- nlsLM(baranyi_log10, S1.2_10hrsT2, trace=T, 
                           list (LOG10N0 = 0.86,lag = 336, mumax = 0.018, LOG10Nmax = 8.22), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
candidate_models[[1]] <- fitS1.2_10T2.buc_LM
candidate_models[[2]] <- fitS1.2_10T2.gom_LM
candidate_models[[3]] <- fitS1.2_10T2.bar_LM
mod.names <- c("Buchanan", "Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS1.2_10T2.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)
my_model <- "modGompertz"

primary_model_data("modGompertz")

#switched N0 and Nmax because values did not make sense
my_pars <- list(logN0 = 1.08, C = 7.10, mu = 0.013, lambda = 192)

my_time <- seq(0, 1000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```


###1.2-Skim-10-Trial 3
```{r}
#1.2-Skim-10c
S1.2_10T3 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 3) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S1.2_10hrsT3 <- S1.2_10T3[c("LOG10N", "t")]

#reorder by column index
S1.2_10hrsT3 <- S1.2_10hrsT3[c(2,1)]

S1.2_10hrsT3 <- S1.2_10hrsT3 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S1.2_10hrsT3, list(LOG10N0 = 0.40,lag = 168, mumax = 0.038, LOG10Nmax = 8.32))
# Fit the data with the model.
fitS1.2_10T3.buc_LM <- nlsLM(buchanan_log10, S1.2_10hrsT3, trace=T, 
                         list (LOG10N0 = 0.40,lag = 168, mumax = 0.038, LOG10Nmax = 8.32), 
                          control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                          lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

#could not fit buchannan

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S1.2_10hrsT3, list(LOG10N0 = 0.40,lag = 168, mumax = 0.038, LOG10Nmax = 8.32))
fitS1.2_10T3.gom_LM <- nlsLM(gompertzm_log10, S1.2_10hrsT3, trace=T, 
                           list (LOG10N0 = 0.40,lag = 168, mumax = 0.038, LOG10Nmax = 8.32), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S1.2_10hrsT3, list(LOG10N0 = 0.40,lag = 168, mumax = 0.038, LOG10Nmax = 8.32))
fitS1.2_10T3.bar_LM <- nlsLM(baranyi_log10, S1.2_10hrsT3, trace=T, 
                           list (LOG10N0 = 0.40,lag = 168, mumax = 0.038, LOG10Nmax = 8.32), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitS1.2_10T2.buc_LM
candidate_models[[1]] <- fitS1.2_10T3.gom_LM
candidate_models[[2]] <- fitS1.2_10T3.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS1.2_10T3.gom_LM)
coef(fitS1.2_10T3.bar_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)
my_model <- "modGompertz"

primary_model_data("modGompertz")

#switched N0 and Nmax because values did not make sense
my_pars <- list(logN0 = 0.39, C = 6.51, mu = 0.078, lambda = 195)

my_time <- seq(0, 1000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)


my_model <- "Baranyi"

primary_model_data("Baranyi")

#switched N0 and Nmax because values did not make sense
my_pars <- list(logN0 = 0.40, logNmax = 6.90, mu = 0.063, lambda = 228)

my_time <- seq(0, 1000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```




###1.2-Skim-10-Trial 4
```{r}
#1.2-Skim-10c
S1.2_10T4 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 1.2) %>% 
  filter(Trial == 4) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S1.2_10hrsT4 <- S1.2_10T4[c("LOG10N", "t")]

#reorder by column index
S1.2_10hrsT4 <- S1.2_10hrsT4[c(2,1)]

S1.2_10hrsT4 <- S1.2_10hrsT4 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S1.2_10hrsT4, list(LOG10N0 = 0.40,lag = 168, mumax = 0.023, LOG10Nmax = 6.90))
# Fit the data with the model.
fitS1.2_10T4.buc_LM <- nlsLM(buchanan_log10, S1.2_10hrsT4, trace=T, 
                         list (LOG10N0 = 0.40,lag = 168, mumax = 0.023, LOG10Nmax = 6.90), 
                          control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                          lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

#could not fit buchannan

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S1.2_10hrsT4, list(LOG10N0 = 0.40,lag = 168, mumax = 0.023, LOG10Nmax = 6.90))
fitS1.2_10T4.gom_LM <- nlsLM(gompertzm_log10, S1.2_10hrsT4, trace=T, 
                           list (LOG10N0 = 0.40,lag = 168, mumax = 0.023, LOG10Nmax = 6.90), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S1.2_10hrsT4, list(LOG10N0 = 0.40,lag = 168, mumax = 0.023, LOG10Nmax = 6.90))
fitS1.2_10T4.bar_LM <- nlsLM(baranyi_log10, S1.2_10hrsT4, trace=T, 
                           list (LOG10N0 = 0.40,lag = 168, mumax = 0.023, LOG10Nmax = 6.90), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitS1.2_10T2.buc_LM
candidate_models[[1]] <- fitS1.2_10T4.gom_LM
candidate_models[[2]] <- fitS1.2_10T4.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS1.2_10T4.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)
my_model <- "modGompertz"

primary_model_data("modGompertz")

#set N max to observed N max of 6.90 because estimated was below 6 log
my_pars <- list(logN0 = 0.33, C = 6.57, mu = 0.028, lambda = 183)

my_time <- seq(0, 2000, length = 2000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```









###0.8-Skim-10 (COMPLETE 2)
```{r}
##Filter by storage/HTST temp
#0.8-Skim-10c
S0.8_10 <- mfkeep %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S0.8_10hrs <- S0.8_10[c("LOG10N", "t")]

#reorder by column index
S0.8_10hrs <- S0.8_10hrs[c(2,1)]

S0.8_10hrs <- S0.8_10hrs %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
#preview(buchanan_log10, S0.8_10hrs, list(LOG10N0 = 1.67,lag = 168, mumax = 0.025, LOG10Nmax = 8.05))
# Fit the data with the model.
#fitS0.8_10.buc_LM <- nlsLM(buchanan_log10, S0.8_10hrs, trace=T, 
                        #   list (LOG10N0 = 1.67,lag = 168, mumax = 0.025, LOG10Nmax = 8.05), 
                       #    control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                        #   lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

#buchanan did not fit

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S0.8_10hrs, list(LOG10N0 = 1.67,lag = 252, mumax = 0.025, LOG10Nmax = 8.05))
fitS0.8_10.gom_LM <- nlsLM(gompertzm_log10, S0.8_10hrs, trace=T, 
                           list (LOG10N0 = 1.67,lag = 252, mumax = 0.025, LOG10Nmax = 8.05), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S0.8_10hrs, list(LOG10N0 = 1.67,lag = 252, mumax = 0.025, LOG10Nmax = 8.05))
fitS0.8_10.bar_LM <- nlsLM(baranyi_log10, S0.8_10hrs, trace=T, 
                           list (LOG10N0 = 1.67,lag = 252, mumax = 0.025, LOG10Nmax = 8.05), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitS0.8_10.buc_LM
candidate_models[[1]] <- fitS0.8_10.gom_LM
candidate_models[[2]] <- fitS0.8_10.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS0.8_10.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)
my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 1.66, C = 5.48, mu = 0.037, lambda = 144)

my_time <- seq(0, 1000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

```



###0.8-Skim-10-T2
```{r}
##Filter by storage/HTST temp
#0.8-Skim-10c
S0.8_10_T2 <- mfkeep %>% 
  filter(Trial == 2) %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S0.8_10hrs_T2 <- S0.8_10_T2[c("LOG10N", "t")]

#reorder by column index
S0.8_10hrs_T2 <- S0.8_10hrs_T2[c(2,1)]

S0.8_10hrs_T2 <- S0.8_10hrs_T2 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S0.8_10hrs_T2, list(LOG10N0 = 2.85,lag = 168, mumax = 0.025, LOG10Nmax = 7.56))
# Fit the data with the model.
fitS0.8_10_T2.buc_LM <- nlsLM(buchanan_log10, S0.8_10hrs_T2, trace=T, 
                           list (LOG10N0 = 2.85,lag = 168, mumax = 0.025, LOG10Nmax = 7.56), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not run

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S0.8_10hrs_T2, list(LOG10N0 = 2.85,lag = 168, mumax = 0.025, LOG10Nmax = 7.56))
fitS0.8_10_T2.gom_LM <- nlsLM(gompertzm_log10, S0.8_10hrs_T2, trace=T, 
                           list (LOG10N0 = 2.85,lag = 168, mumax = 0.025, LOG10Nmax = 7.56), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S0.8_10hrs_T2, list(LOG10N0 = 2.85,lag = 168, mumax = 0.025, LOG10Nmax = 7.56))
fitS0.8_10_T2.bar_LM <- nlsLM(baranyi_log10, S0.8_10hrs_T2, trace=T, 
                           list (LOG10N0 = 2.85,lag = 168, mumax = 0.025, LOG10Nmax = 7.56), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitS0.8_10.buc_LM
candidate_models[[1]] <- fitS0.8_10_T2.gom_LM
candidate_models[[2]] <- fitS0.8_10_T2.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS0.8_10_T2.gom_LM)
coef(fitS0.8_10_T2.bar_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```
```{r}
library(biogrowth)

set.seed(88)
my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 2.75, C = 3.71, mu = 0.097, lambda = 187)

my_time <- seq(0, 1000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)

my_model <- "Baranyi"

primary_model_data("Baranyi")

my_pars <- list(logN0 = 2.75, logNmax = 6.46, mu = 0.092, lambda = 228)

my_time <- seq(0, 1000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)


```


###0.8-Skim-10-T3
```{r}
##Filter by storage/HTST temp
#0.8-Skim-10c
S0.8_10_T3 <- mfkeep %>% 
  filter(Trial == 3) %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S0.8_10hrs_T3 <- S0.8_10_T3[c("LOG10N", "t")]

#reorder by column index
S0.8_10hrs_T3 <- S0.8_10hrs_T3[c(2,1)]

S0.8_10hrs_T3 <- S0.8_10hrs_T3 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S0.8_10hrs_T3, list(LOG10N0 = 0.40,lag = 168, mumax = 0.031, LOG10Nmax = 8.53))
# Fit the data with the model.
fitS0.8_10_T3.buc_LM <- nlsLM(buchanan_log10, S0.8_10hrs_T3, trace=T, 
                           list (LOG10N0 = 0.40,lag = 168, mumax = 0.031, LOG10Nmax = 8.53), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))
#could not fit

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S0.8_10hrs_T3, list(LOG10N0 = 0.40,lag = 168, mumax = 0.031, LOG10Nmax = 8.53))
fitS0.8_10_T3.gom_LM <- nlsLM(gompertzm_log10, S0.8_10hrs_T3, trace=T, 
                           list (LOG10N0 = 0.40,lag = 168, mumax = 0.031, LOG10Nmax = 8.53), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))


# Fit model 3: baranyi_log10
preview(baranyi_log10, S0.8_10hrs_T3, list(LOG10N0 = 0.40,lag = 168, mumax = 0.031, LOG10Nmax = 8.53))
fitS0.8_10_T3.bar_LM <- nlsLM(baranyi_log10, S0.8_10hrs_T3, trace=T, 
                           list (LOG10N0 = 0.40,lag = 168, mumax = 0.031, LOG10Nmax = 8.53), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
#candidate_models[[1]] <- fitS0.8_10.buc_LM
candidate_models[[1]] <- fitS0.8_10_T3.gom_LM
candidate_models[[2]] <- fitS0.8_10_T3.bar_LM
mod.names <- c("Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS0.8_10_T3.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)
my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 0.37, C = 7.43, mu = 0.036, lambda = 140)

my_time <- seq(0, 1000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)
```

###0.8-Skim-10-T4
```{r}
##Filter by storage/HTST temp
#0.8-Skim-10c
S0.8_10_T4 <- mfkeep %>% 
  filter(Trial == 4) %>% 
  filter(StorageTemp == 10) %>% 
  filter(PoreSize == 0.8) %>% 
  filter(MilkType == "Skim") %>% 
  filter(PlateType == "SPC") %>% 
  dplyr::select(Concentration, Day) %>% 
  filter(!is.na(Concentration)) %>% 
  mutate(Day = Day*24) %>% 
  rename(t = Day) %>% 
  mutate(Concentration = replace(Concentration, Concentration==0, 2.5)) %>%
  mutate(Concentration = log10(Concentration)) %>% 
  rename(LOG10N = Concentration)

S0.8_10hrs_T4 <- S0.8_10_T4[c("LOG10N", "t")]

#reorder by column index
S0.8_10hrs_T4 <- S0.8_10hrs_T4[c(2,1)]

S0.8_10hrs_T4 <- S0.8_10hrs_T4 %>%
  group_by(t) %>% 
  summarise_at(vars(LOG10N), list(LOG10N = mean)) 
```

```{r}
# Three candidate growth models
# 1. buchanan (in log10 scale)
# 2. gompertzm (in log10 scale)
# 3. baranyi (in log10 scale)

# Fit model 1: buchanan_log10
# Preview the curve for setting up starting values of the parameters.
preview(buchanan_log10, S0.8_10hrs_T4, list(LOG10N0 = 1.75,lag = 84, mumax = 0.018, LOG10Nmax = 7.98))
# Fit the data with the model.
fitS0.8_10_T4.buc_LM <- nlsLM(buchanan_log10, S0.8_10hrs_T4, trace=T, 
                           list (LOG10N0 = 1.75,lag = 84, mumax = 0.018, LOG10Nmax = 7.98), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))

# Fit model 2: gompertzm_log10
preview(gompertzm_log10, S0.8_10hrs_T4, list(LOG10N0 = 1.75,lag = 84, mumax = 0.018, LOG10Nmax = 7.98))
fitS0.8_10_T4.gom_LM <- nlsLM(gompertzm_log10, S0.8_10hrs_T4, trace=T, 
                           list (LOG10N0 = 1.75,lag = 84, mumax = 0.018, LOG10Nmax = 7.98), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Fit model 3: baranyi_log10
preview(baranyi_log10, S0.8_10hrs_T4, list(LOG10N0 = 1.75,lag = 84, mumax = 0.018, LOG10Nmax = 7.98))
fitS0.8_10_T4.bar_LM <- nlsLM(baranyi_log10, S0.8_10hrs_T4, trace=T, 
                           list (LOG10N0 = 1.75,lag = 84, mumax = 0.018, LOG10Nmax = 7.98), 
                           control = nls.control(maxiter = 100, minFactor = 1/4096, warnOnly = T),
                           lower = c(LOG10N0 = 0,lag = 0, mumax = 0, LOG10Nmax = 0))



# Compare across models to select the best-fit model.
candidate_models <- list()
candidate_models[[1]] <- fitS0.8_10_T4.buc_LM
candidate_models[[2]] <- fitS0.8_10_T4.gom_LM
candidate_models[[3]] <- fitS0.8_10_T4.bar_LM
mod.names <- c("Buchannan", "Gompertzm", "Baranyi")
output_bic <- bictab(cand.set = candidate_models, modnames = mod.names, sort = TRUE)
print(output_bic)


coef(fitS0.8_10_T4.gom_LM)

### Ideally we would like to write a script to do it in one go, but the annoying thing
### is that setting up the starting values needs to be done manually as we need to see
### the plots to determine if the starting values are good enough. Please let me know
### if you figure out better ways to streamline this!
```


```{r}
library(biogrowth)

set.seed(88)
my_model <- "modGompertz"

primary_model_data("modGompertz")

my_pars <- list(logN0 = 1.68, C = 5.83, mu = 0.019, lambda = 59)

my_time <- seq(0, 1000, length = 1000)

static_prediction <- predict_isothermal_growth(my_model, my_time, my_pars)

static_prediction$simulation

plot(static_prediction) +
  xlab("Storage time (h)") + 
  ylab("Microbial count (log CFU/mL)") +
  theme_gray()

time_to_logcount(static_prediction, 4.301)

time_to_logcount(static_prediction, 6.0)
```